package com.example.cloudpush;

import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;

import org.json.JSONException;
import org.json.JSONObject;

import android.content.Context;
import android.content.Intent;
import android.text.TextUtils;
import android.util.Log;

import com.baidu.frontia.api.FrontiaPushMessageReceiver;

/**
 * Pushæ¶ˆæ¯å¤„ç†receiverã€‚è¯·ç¼–å†™æ‚¨éœ€è¦çš„å›è°ƒå‡½æ•°ï¼? ä¸?èˆ¬æ¥è¯´ï¼š onBindæ˜¯å¿…é¡»çš„ï¼Œç”¨æ¥å¤„ç†startWorkè¿”å›å€¼ï¼›
 * onMessageç”¨æ¥æ¥æ”¶é€ä¼ æ¶ˆæ¯ï¼? onSetTagsã€onDelTagsã€onListTagsæ˜¯tagç›¸å…³æ“ä½œçš„å›è°ƒï¼›
 * onNotificationClickedåœ¨é?šçŸ¥è¢«ç‚¹å‡»æ—¶å›è°ƒï¼? onUnbindæ˜¯stopWorkæ¥å£çš„è¿”å›å?¼å›è°?
 * 
 * è¿”å›å€¼ä¸­çš„errorCodeï¼Œè§£é‡Šå¦‚ä¸‹ï¼š 
 *  0 - Success
 *  10001 - Network Problem
 *  30600 - Internal Server Error
 *  30601 - Method Not Allowed 
 *  30602 - Request Params Not Valid
 *  30603 - Authentication Failed 
 *  30604 - Quota Use Up Payment Required 
 *  30605 - Data Required Not Found 
 *  30606 - Request Time Expires Timeout 
 *  30607 - Channel Token Timeout 
 *  30608 - Bind Relation Not Found 
 *  30609 - Bind Number Too Many
 * 
 * å½“æ‚¨é‡åˆ°ä»¥ä¸Šè¿”å›é”™è¯¯æ—¶ï¼Œå¦‚æœè§£é‡Šä¸äº†æ‚¨çš„é—®é¢˜ï¼Œè¯·ç”¨åŒä¸?è¯·æ±‚çš„è¿”å›å?¼requestIdå’ŒerrorCodeè”ç³»æˆ‘ä»¬è¿½æŸ¥é—®é¢˜ã€?
 * 
 */
public class MyPushMessageReceiver extends FrontiaPushMessageReceiver {
    /** TAG to Log */
    public static final String TAG = MyPushMessageReceiver.class
            .getSimpleName();

    /**
     * è°ƒç”¨PushManager.startWorkåï¼Œsdkå°†å¯¹push
     * serverå‘èµ·ç»‘å®šè¯·æ±‚ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ã?‚ç»‘å®šè¯·æ±‚çš„ç»“æœé€šè¿‡onBindè¿”å›ã€? å¦‚æœæ‚¨éœ€è¦ç”¨å•æ’­æ¨é?ï¼Œéœ?è¦æŠŠè¿™é‡Œè·å–çš„channel
     * idå’Œuser idä¸Šä¼ åˆ°åº”ç”¨serverä¸­ï¼Œå†è°ƒç”¨serveræ¥å£ç”¨channel idå’Œuser idç»™å•ä¸ªæ‰‹æœºæˆ–è€…ç”¨æˆ·æ¨é€ã??
     * 
     * @param context
     *            BroadcastReceiverçš„æ‰§è¡ŒContext
     * @param errorCode
     *            ç»‘å®šæ¥å£è¿”å›å€¼ï¼Œ0 - æˆåŠŸ
     * @param appid
     *            åº”ç”¨idã€‚errorCodeé?0æ—¶ä¸ºnull
     * @param userId
     *            åº”ç”¨user idã€‚errorCodeé?0æ—¶ä¸ºnull
     * @param channelId
     *            åº”ç”¨channel idã€‚errorCodeé?0æ—¶ä¸ºnull
     * @param requestId
     *            å‘æœåŠ¡ç«¯å‘èµ·çš„è¯·æ±‚idã€‚åœ¨è¿½æŸ¥é—®é¢˜æ—¶æœ‰ç”¨ï¼›
     * @return none
     */
    @Override
    public void onBind(Context context, int errorCode, String appid,
            String userId, String channelId, String requestId) {
        String responseString = "onBind errorCode=" + errorCode + " appid="
                + appid + " userId=" + userId + " channelId=" + channelId
                + " requestId=" + requestId;
        Log.d(TAG, responseString);

        // ç»‘å®šæˆåŠŸï¼Œè®¾ç½®å·²ç»‘å®šflagï¼Œå¯ä»¥æœ‰æ•ˆçš„å‡å°‘ä¸å¿…è¦çš„ç»‘å®šè¯·æ±‚
        if (errorCode == 0) {
            Utils.setBind(context, true);
        }
        // Demoæ›´æ–°ç•Œé¢å±•ç¤ºä»£ç ï¼Œåº”ç”¨è¯·åœ¨è¿™é‡ŒåŠ å…¥è‡ªå·±çš„å¤„ç†é€»è¾‘
        updateContent(context, responseString);
    }

    /**
     * æ¥æ”¶é€ä¼ æ¶ˆæ¯çš„å‡½æ•°ã??
     * 
     * @param context
     *            ä¸Šä¸‹æ–?
     * @param message
     *            æ¨é?çš„æ¶ˆæ¯
     * @param customContentString
     *            è‡ªå®šä¹‰å†…å®?,ä¸ºç©ºæˆ–è?…jsonå­—ç¬¦ä¸?
     */
    @Override
    public void onMessage(Context context, String message,
            String customContentString) {
        String messageString = "é€ä¼ æ¶ˆæ¯ message=\"" + message
                + "\" customContentString=" + customContentString;
        Log.d(TAG, messageString);

        // è‡ªå®šä¹‰å†…å®¹è·å–æ–¹å¼ï¼Œmykeyå’Œmyvalueå¯¹åº”é€ä¼ æ¶ˆæ¯æ¨é?æ—¶è‡ªå®šä¹‰å†…å®¹ä¸­è®¾ç½®çš„é”®å’Œå??
        if (!TextUtils.isEmpty(customContentString)) {
            JSONObject customJson = null;
            try {
                customJson = new JSONObject(customContentString);
                String myvalue = null;
                if (!customJson.isNull("mykey")) {
                    myvalue = customJson.getString("mykey");
                }
            } catch (JSONException e) {
                // TODO Auto-generated catch block
                e.printStackTrace();
            }
        }

        // Demoæ›´æ–°ç•Œé¢å±•ç¤ºä»£ç ï¼Œåº”ç”¨è¯·åœ¨è¿™é‡ŒåŠ å…¥è‡ªå·±çš„å¤„ç†é€»è¾‘
        updateContent(context, messageString);
    }

    /**
     * æ¥æ”¶é€šçŸ¥ç‚¹å‡»çš„å‡½æ•°ã?‚æ³¨ï¼šæ¨é€é?šçŸ¥è¢«ç”¨æˆ·ç‚¹å‡»å‰ï¼Œåº”ç”¨æ— æ³•é?šè¿‡æ¥å£è·å–é€šçŸ¥çš„å†…å®¹ã??
     * 
     * @param context
     *            ä¸Šä¸‹æ–?
     * @param title
     *            æ¨é?çš„é€šçŸ¥çš„æ ‡é¢?
     * @param description
     *            æ¨é?çš„é€šçŸ¥çš„æè¿?
     * @param customContentString
     *            è‡ªå®šä¹‰å†…å®¹ï¼Œä¸ºç©ºæˆ–è?…jsonå­—ç¬¦ä¸?
     */
    @Override
    public void onNotificationClicked(Context context, String title,
            String description, String customContentString) {
        String notifyString = "é€šçŸ¥ç‚¹å‡» title=\"" + title + "\" description=\""
                + description + "\" customContent=" + customContentString;
        Log.d(TAG, notifyString);

        // è‡ªå®šä¹‰å†…å®¹è·å–æ–¹å¼ï¼Œmykeyå’Œmyvalueå¯¹åº”é€šçŸ¥æ¨é?æ—¶è‡ªå®šä¹‰å†…å®¹ä¸­è®¾ç½®çš„é”®å’Œå??
        if (!TextUtils.isEmpty(customContentString)) {
            JSONObject customJson = null;
            try {
                customJson = new JSONObject(customContentString);
                String myvalue = null;
                if (!customJson.isNull("mykey")) {
                    myvalue = customJson.getString("mykey");
                }
            } catch (JSONException e) {
                // TODO Auto-generated catch block
                e.printStackTrace();
            }
        }

        // Demoæ›´æ–°ç•Œé¢å±•ç¤ºä»£ç ï¼Œåº”ç”¨è¯·åœ¨è¿™é‡ŒåŠ å…¥è‡ªå·±çš„å¤„ç†é€»è¾‘
        updateContent(context, notifyString);
    }

    /**
     * setTags() çš„å›è°ƒå‡½æ•°ã??
     * 
     * @param context
     *            ä¸Šä¸‹æ–?
     * @param errorCode
     *            é”™è¯¯ç ã??0è¡¨ç¤ºæŸäº›tagå·²ç»è®¾ç½®æˆåŠŸï¼›é0è¡¨ç¤ºæ‰?æœ‰tagçš„è®¾ç½®å‡å¤±è´¥ã€?
     * @param successTags
     *            è®¾ç½®æˆåŠŸçš„tag
     * @param failTags
     *            è®¾ç½®å¤±è´¥çš„tag
     * @param requestId
     *            åˆ†é…ç»™å¯¹äº‘æ¨é€çš„è¯·æ±‚çš„id
     */
    @Override
    public void onSetTags(Context context, int errorCode,
            List<String> sucessTags, List<String> failTags, String requestId) {
        String responseString = "onSetTags errorCode=" + errorCode
                + " sucessTags=" + sucessTags + " failTags=" + failTags
                + " requestId=" + requestId;
        Log.d(TAG, responseString);

        // Demoæ›´æ–°ç•Œé¢å±•ç¤ºä»£ç ï¼Œåº”ç”¨è¯·åœ¨è¿™é‡ŒåŠ å…¥è‡ªå·±çš„å¤„ç†é€»è¾‘
        updateContent(context, responseString);
    }

    /**
     * delTags() çš„å›è°ƒå‡½æ•°ã??
     * 
     * @param context
     *            ä¸Šä¸‹æ–?
     * @param errorCode
     *            é”™è¯¯ç ã??0è¡¨ç¤ºæŸäº›tagå·²ç»åˆ é™¤æˆåŠŸï¼›é0è¡¨ç¤ºæ‰?æœ‰tagå‡åˆ é™¤å¤±è´¥ã??
     * @param successTags
     *            æˆåŠŸåˆ é™¤çš„tag
     * @param failTags
     *            åˆ é™¤å¤±è´¥çš„tag
     * @param requestId
     *            åˆ†é…ç»™å¯¹äº‘æ¨é€çš„è¯·æ±‚çš„id
     */
    @Override
    public void onDelTags(Context context, int errorCode,
            List<String> sucessTags, List<String> failTags, String requestId) {
        String responseString = "onDelTags errorCode=" + errorCode
                + " sucessTags=" + sucessTags + " failTags=" + failTags
                + " requestId=" + requestId;
        Log.d(TAG, responseString);

        // Demoæ›´æ–°ç•Œé¢å±•ç¤ºä»£ç ï¼Œåº”ç”¨è¯·åœ¨è¿™é‡ŒåŠ å…¥è‡ªå·±çš„å¤„ç†é€»è¾‘
        updateContent(context, responseString);
    }

    /**
     * listTags() çš„å›è°ƒå‡½æ•°ã??
     * 
     * @param context
     *            ä¸Šä¸‹æ–?
     * @param errorCode
     *            é”™è¯¯ç ã??0è¡¨ç¤ºåˆ—ä¸¾tagæˆåŠŸï¼›é0è¡¨ç¤ºå¤±è´¥ã€?
     * @param tags
     *            å½“å‰åº”ç”¨è®¾ç½®çš„æ‰€æœ‰tagã€?
     * @param requestId
     *            åˆ†é…ç»™å¯¹äº‘æ¨é€çš„è¯·æ±‚çš„id
     */
    @Override
    public void onListTags(Context context, int errorCode, List<String> tags,
            String requestId) {
        String responseString = "onListTags errorCode=" + errorCode + " tags="
                + tags;
        Log.d(TAG, responseString);

        // Demoæ›´æ–°ç•Œé¢å±•ç¤ºä»£ç ï¼Œåº”ç”¨è¯·åœ¨è¿™é‡ŒåŠ å…¥è‡ªå·±çš„å¤„ç†é€»è¾‘
        updateContent(context, responseString);
    }

    /**
     * PushManager.stopWork() çš„å›è°ƒå‡½æ•°ã??
     * 
     * @param context
     *            ä¸Šä¸‹æ–?
     * @param errorCode
     *            é”™è¯¯ç ã??0è¡¨ç¤ºä»äº‘æ¨é?è§£ç»‘å®šæˆåŠŸï¼›é0è¡¨ç¤ºå¤±è´¥ã€?
     * @param requestId
     *            åˆ†é…ç»™å¯¹äº‘æ¨é€çš„è¯·æ±‚çš„id
     */
    @Override
    public void onUnbind(Context context, int errorCode, String requestId) {
        String responseString = "onUnbind errorCode=" + errorCode
                + " requestId = " + requestId;
        Log.d(TAG, responseString);

        // è§£ç»‘å®šæˆåŠŸï¼Œè®¾ç½®æœªç»‘å®šflagï¼?
        if (errorCode == 0) {
            Utils.setBind(context, false);
        }
        // Demoæ›´æ–°ç•Œé¢å±•ç¤ºä»£ç ï¼Œåº”ç”¨è¯·åœ¨è¿™é‡ŒåŠ å…¥è‡ªå·±çš„å¤„ç†é€»è¾‘
        updateContent(context, responseString);
    }

    private void updateContent(Context context, String content) {
        Log.d(TAG, "updateContent");
        String logText = "" + Utils.logStringCache;

        if (!logText.equals("")) {
            logText += "\n";
        }

        SimpleDateFormat sDateFormat = new SimpleDateFormat("HH-mm-ss");
        logText += sDateFormat.format(new Date()) + ": ";
        logText += content;

        Utils.logStringCache = logText;

        Intent intent = new Intent();
        intent.setClass(context.getApplicationContext(), MainActivity.class);
        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
        context.getApplicationContext().startActivity(intent);
    }

}
